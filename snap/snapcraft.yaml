name: rpi-imager
base: core20
adopt-info: imagewriter
summary: Raspberry Pi Imager
website: https://www.raspberrypi.com/software/
source-code: https://github.com/raspberrypi/rpi-imager
issues: https://github.com/waveform80/imager-snap
icon: images/rpi-imager.png
license: Apache-2.0
description: |
  Raspberry Pi Imager is an easy to use application for installing Raspberry Pi
  OS, or other operating systems, to an SD card ready to use with your
  Raspberry Pi.

  Usage is as simple as:

  1. Pick the operating system you want to write.

  2. Pick the storage you want to write it to (SD card, hard drive, SSD, etc.)

  3. Click "WRITE" and wait.

  The application also verifies that the operating system has been written
  correctly after writing has finished. With certain operating system images,
  the imager also supports customizing the first boot configuration (look for
  the "cog" icon in the lower right of the main window).
compression: lzo
grade: stable
confinement: strict

apps:
  rpi-imager:
    command: usr/local/bin/rpi-imager
    command-chain:
      - bin/desktop-launch
    desktop: usr/local/share/applications/rpi-imager.desktop
    environment:
      DISABLE_WAYLAND: 1
      # Use GTK3 cursor theme, icon theme and open/save file dialogs
      QT_QPA_PLATFORMTHEME: gtk3
    plugs:
      - x11
      - opengl
      - network
      - desktop
      - desktop-legacy
      - home
      - removable-media  # required to re-write first-boot configuration
      - mount-observe    # required to report mounts on target media
      - network-manager  # required to grab image
      - network-control
      - cifs-mount
      - udisks2          # required for writing to sd card
      - hardware-observe # required to find card with lsblk
      - wayland          # required for theming on wayland
      - gsettings        # required for theming on wayland

plugs:
  # Support for common GTK themes
  # https://forum.snapcraft.io/t/how-to-use-the-system-gtk-theme-via-the-gtk-common-themes-snap/6235
  gsettings:
  gtk-3-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/data-dir/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/data-dir/sounds
    default-provider: gtk-common-themes

parts:
  desktop-qt5:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: qt
    plugin: make
    make-parameters: ["FLAVOR=qt5"]
    build-packages:
      - build-essential
      - qtbase5-dev
      - dpkg-dev
    stage-packages:
      - libxkbcommon0
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libqt5gui5
      - libgtk2.0-0
      - libgdk-pixbuf2.0-0
      - libqt5svg5 # for loading icon themes which are svg
      - locales-all
      - xdg-user-dirs
      - fcitx-frontend-qt5
  qt5-gtk-platform:
    plugin: nil
    stage-packages:
      - qt5-gtk-platformtheme
    build-packages:
      - libglib2.0-bin
    override-prime: |
      snapcraftctl prime
      glib-compile-schemas "$SNAPCRAFT_PRIME"/usr/share/glib-2.0/schemas
  imagewriter:
    plugin: cmake
    cmake-parameters:
      - -DENABLE_CHECK_VERSION=OFF
    source: https://github.com/raspberrypi/rpi-imager.git
    source-subdir: src
    source-type: git
    override-pull: |
      snapcraftctl pull
      last_committed_tag="$(git describe --tags $(git rev-list --tags --max-count=1))"
      last_committed_tag_ver="$(echo ${last_committed_tag} | sed 's/v//' )"
      last_released_tag=""
      for channel in beta candidate stable; do
        last_released_tag="$(
          snap info "$SNAPCRAFT_PROJECT_NAME" 2>/dev/null |
          awk -v channel="latest/$channel" '$1 == channel { print $2; }'
        )"
        [ -z "$last_released_tag" ] && break
        [ "$last_released_tag" != "â†‘" ] && break
      done
      # If the latest tag from the upstream project has not been released to
      # beta (or above), build that tag instead of master.
      if [ "$last_committed_tag_ver" != "$last_released_tag" ]; then
        git fetch
        git checkout "$last_committed_tag"
        echo "Setting version to $last_committed_tag"
        snapcraftctl set-version "$last_committed_tag_ver"
      else
        echo "Setting version to $(git describe --tags)"
        snapcraftctl set-version "$(git describe --tags)"
      fi
      # Strip out the vendored dependencies and embedded source
      if [ -d "$SNAPCRAFT_PART_SRC"/embedded ]; then
        rm -fr "$SNAPCRAFT_PART_SRC"/embedded
      fi
      if [ -d "$SNAPCRAFT_PART_SRC"/src/dependencies ]; then
        pushd "$SNAPCRAFT_PART_SRC"/src/dependencies
        for d in cmcurl cmliblzma fat32format libarchive-* zlib-* zstd-*; do
          rm -fr "$d"
        done
        popd
      fi
      # Point the icon to the right place
      sed -i -e \
        's|^Icon=rpi-imager|Icon=/usr/local/share/icons/hicolor/128x128/apps/rpi-imager.png|' \
        "$SNAPCRAFT_PART_SRC"/src/linux/rpi-imager.desktop
    stage-packages:
      - qml-module-qtquick2
      - qml-module-qtquick-controls2
      - qml-module-qtquick-layouts
      - qml-module-qtquick-templates2
      - qml-module-qtquick-window2
      - qml-module-qtgraphicaleffects
      - dosfstools
      - fdisk
      - libarchive13
      - libcurl4
    build-packages:
      - build-essential
      - devscripts
      - libarchive-dev
      - libcurl4-openssl-dev
      - qtbase5-dev
      - qtbase5-dev-tools
      - qtdeclarative5-dev
      - qttools5-dev-tools
      - qttools5-dev
      - libqt5svg5-dev
      - libssl-dev
